# æµ‹è¯•è„šæœ¬å’Œå·¥å…·

# RPC å…¼å®¹æ€§æµ‹è¯•å™¨
rpc-compatibility-test:
	#!/usr/bin/env bash
	echo "ðŸ” Starting RPC compatibility test..."
	cargo run --bin rpc-compatibility-tester -- \
		--nitro-endpoint http://localhost:8547 \
		--reth-endpoint http://localhost:8548 \
		--test-suite full \
		--report-format json \
		--output ./reports/rpc-compatibility-$(date +%Y%m%d-%H%M%S).json

# æ€§èƒ½åŸºå‡†æµ‹è¯•
benchmark-performance-suite:
	#!/usr/bin/env bash
	echo "âš¡ Starting performance benchmark..."
	mkdir -p reports benchmarks
	cargo run --release --bin performance-benchmark -- \
		--duration 3600 \
		--report-interval 60 \
		--output ./reports/performance-$(date +%Y%m%d).json \
		--nitro-endpoint http://localhost:8547 \
		--reth-endpoint http://localhost:8548

# æ•°æ®ä¸€è‡´æ€§éªŒè¯
data-consistency-check:
	#!/usr/bin/env bash
	echo "ðŸ“Š Verifying data consistency..."
	cargo run --bin data-consistency-checker -- \
		--nitro-datadir ./test-data/nitro \
		--reth-datadir ./test-data/reth \
		--start-block 0 \
		--end-block 10000 \
		--output ./reports/consistency-$(date +%Y%m%d).json

# ç½‘ç»œåŒæ­¥æµ‹è¯•
sync-test:
	#!/usr/bin/env bash
	echo "ðŸ”„ Testing network synchronization..."
	cargo run --bin sync-tester -- \
		--network arbitrum-sepolia \
		--checkpoint-interval 1000 \
		--validate-state true \
		--timeout 7200 \
		--output ./reports/sync-test-$(date +%Y%m%d).json

# å®Œæ•´å…¼å®¹æ€§æµ‹è¯•å¥—ä»¶
test-compatibility-suite:
	#!/usr/bin/env bash
	echo "ðŸš€ Running full compatibility test suite..."

	# ç¡®ä¿ç›®å½•å­˜åœ¨
	mkdir -p reports logs test-data/{nitro,reth}

	echo "Step 1: Basic functionality tests"
	cargo test --workspace --release -- --nocapture 2>&1 | tee logs/unit-tests-$(date +%Y%m%d).log

	echo "Step 2: RPC compatibility"
	just rpc-compatibility-test

	echo "Step 3: Data consistency"
	just data-consistency-check

	echo "Step 4: Performance benchmark"
	just benchmark-performance-suite

	echo "Step 5: Sync test"
	just sync-test

	echo "âœ… Compatibility test suite completed"
	echo "ðŸ“ˆ Reports available in ./reports/"

# è®¾ç½®æµ‹è¯•çŽ¯å¢ƒ
full-test-env-setup:
	#!/usr/bin/env bash
	echo "ðŸ› ï¸  Setting up test environment..."

	# åˆ›å»ºå¿…è¦çš„ç›®å½•
	mkdir -p {test-data,reports,logs,benchmarks,compatibility}
	mkdir -p test-data/{nitro,reth}
	mkdir -p {tests/integration,tests/compatibility,tests/performance}

	# ä¸‹è½½ Nitro å‚è€ƒå®žçŽ°ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
	if [ ! -d "nitro-reference" ]; then
		echo "ðŸ“¥ Downloading Nitro reference implementation..."
		git clone https://github.com/OffchainLabs/nitro.git nitro-reference
		cd nitro-reference
		git checkout $(git describe --tags --abbrev=0) # æœ€æ–°ç¨³å®šç‰ˆæœ¬
		cd ..
	fi

	# åˆ›å»ºæµ‹è¯•é…ç½®æ–‡ä»¶
	just create-test-configs

	echo "âœ… Test environment setup completed"

# åˆ›å»ºæµ‹è¯•é…ç½®æ–‡ä»¶
create-test-configs:
	#!/usr/bin/env bash
	echo "ðŸ“ Creating test configuration files..."

	mkdir -p test-configs

	# RPC å…¼å®¹æ€§æµ‹è¯•é…ç½®
	cat > test-configs/rpc-compatibility.toml <<- 'EOF'
	[test]
	nitro_endpoint = "http://localhost:8547"
	reth_endpoint = "http://localhost:8548"
	timeout_seconds = 30
	parallel_requests = 10
	retry_attempts = 3

	[rpc_methods]
	# åŸºç¡€ Ethereum RPC æ–¹æ³•
	ethereum_methods = [
	    "eth_blockNumber",
	    "eth_getBalance",
	    "eth_getTransactionCount", 
	    "eth_getBlockByNumber",
	    "eth_getBlockByHash",
	    "eth_getTransactionByHash",
	    "eth_getTransactionReceipt",
	    "eth_call",
	    "eth_estimateGas",
	    "eth_sendRawTransaction"
	]

	# Arbitrum æ‰©å±•æ–¹æ³•
	arbitrum_methods = [
	    "arb_getL1Confirmations",
	    "arb_estimateComponents", 
	    "arb_getL2ToL1Proof",
	    "arb_findL2ToL1Messages"
	]

	[validation]
	# éªŒè¯è§„åˆ™
	strict_response_matching = true
	allow_timestamp_variance = 5  # ç§’
	allow_gas_estimation_variance = 0.1  # 10%
	EOF

	# æ€§èƒ½æµ‹è¯•é…ç½®
	cat > test-configs/performance.toml <<- 'EOF'
	[benchmark]
	duration_seconds = 3600
	warmup_seconds = 300
	report_interval_seconds = 60

	[targets]
	# æ€§èƒ½ç›®æ ‡
	target_tps = 2000
	max_latency_p95_ms = 100
	max_memory_gb = 4
	max_cpu_percent = 80

	[workload]
	# æµ‹è¯•è´Ÿè½½é…ç½®
	transaction_types = ["transfer", "contract_call", "contract_deploy"]
	transaction_mix = [70, 25, 5]  # ç™¾åˆ†æ¯”
	concurrent_users = 100
	ramp_up_seconds = 60
	EOF

	# æ•°æ®ä¸€è‡´æ€§æµ‹è¯•é…ç½®  
	cat > test-configs/consistency.toml <<- 'EOF'
	[validation]
	# æ•°æ®éªŒè¯è®¾ç½®
	validate_blocks = true
	validate_transactions = true
	validate_receipts = true
	validate_state = true
	validate_logs = true

	[sampling]
	# é‡‡æ ·ç­–ç•¥
	sample_every_n_blocks = 100
	random_sample_percentage = 1.0
	focus_recent_blocks = 1000

	[tolerance]
	# å®¹å·®è®¾ç½®
	timestamp_variance_seconds = 1
	gas_variance_percentage = 0.01
	balance_variance_wei = "0"
	EOF

	echo "âœ… Test configuration files created"

# å¯åŠ¨æœ¬åœ°æµ‹è¯•ç½‘ç»œ
start-local-testnet:
	#!/usr/bin/env bash
	echo "ðŸŒ Starting local test network..."

	# ä½¿ç”¨ Docker Compose å¯åŠ¨æµ‹è¯•çŽ¯å¢ƒ
	if [ ! -f "docker-compose.test.yml" ]; then
		just create-docker-test-config
	fi

	docker-compose -f docker-compose.test.yml up -d
	echo "â³ Waiting for nodes to start..."
	sleep 30

	# éªŒè¯èŠ‚ç‚¹å¯åŠ¨
	echo "ðŸ” Checking node health..."
	curl -s http://localhost:8547/health || echo "âŒ Nitro node not responding"
	curl -s http://localhost:8548/health || echo "âŒ Reth node not responding"

	echo "âœ… Local test network started"

# åˆ›å»º Docker æµ‹è¯•é…ç½®
create-docker-test-config:
	#!/usr/bin/env bash
	echo "ðŸ³ Creating Docker test configuration..."

	cat > docker-compose.test.yml <<- 'EOF'
	version: '3.8'

	services:
	  nitro-node:
	    image: offchainlabs/nitro-node:latest
	    ports:
	      - "8547:8547"
	      - "8548:8548"
	    volumes:
	      - ./test-data/nitro:/data
	    environment:
	      - LOG_LEVEL=info
	    command: |
	      --conf.file=/data/config.json
	      --node.rpc.addr=0.0.0.0
	      --node.rpc.port=8547
	      --node.ws.addr=0.0.0.0  
	      --node.ws.port=8548
	    healthcheck:
	      test: ["CMD", "curl", "-f", "http://localhost:8547/health"]
	      interval: 30s
	      timeout: 10s
	      retries: 3

	  arbitrum-reth:
	    build: 
	      context: .
	      dockerfile: Dockerfile
	    ports:
	      - "8549:8547"
	      - "8550:8548"
	    volumes:
	      - ./test-data/reth:/data
	    environment:
	      - LOG_LEVEL=info
	      - RUST_LOG=info
	    command: |
	      --datadir /data
	      --rpc-addr 0.0.0.0
	      --rpc-port 8547
	      --ws-addr 0.0.0.0
	      --ws-port 8548
	      --metrics
	      --metrics-addr 0.0.0.0:9090
	    healthcheck:
	      test: ["CMD", "curl", "-f", "http://localhost:8547/health"]
	      interval: 30s
	      timeout: 10s
	      retries: 3
	    depends_on:
	      - nitro-node

	  test-runner:
	    build:
	      context: .
	      dockerfile: Dockerfile.test
	    volumes:
	      - ./reports:/reports
	      - ./test-configs:/test-configs
	    environment:
	      - NITRO_ENDPOINT=http://nitro-node:8547
	      - RETH_ENDPOINT=http://arbitrum-reth:8547
	    depends_on:
	      - nitro-node
	      - arbitrum-reth
	    profiles:
	      - test

	networks:
	  default:
	    driver: bridge
	EOF

	echo "âœ… Docker test configuration created"

# åœæ­¢æµ‹è¯•ç½‘ç»œ
stop-local-testnet:
	#!/usr/bin/env bash
	echo "ðŸ›‘ Stopping local test network..."
	docker-compose -f docker-compose.test.yml down -v
	echo "âœ… Local test network stopped"

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
generate-test-report:
	#!/usr/bin/env bash
	echo "ðŸ“Š Generating comprehensive test report..."

	mkdir -p reports/html

	# è¿è¡ŒæŠ¥å‘Šç”Ÿæˆå™¨
	cargo run --bin report-generator -- \
		--input-dir ./reports \
		--output-dir ./reports/html \
		--format html \
		--include-charts true

	echo "âœ… Test report generated: ./reports/html/index.html"

# æ¸…ç†æµ‹è¯•æ•°æ®
clean-test-data:
	#!/usr/bin/env bash
	echo "ðŸ§¹ Cleaning test data..."
	rm -rf test-data/* reports/* logs/*
	docker system prune -f
	echo "âœ… Test data cleaned"

# è¿è¡Œå›žå½’æµ‹è¯•
regression-test:
	#!/usr/bin/env bash
	echo "ðŸ”„ Running regression tests..."

	# ä¿å­˜å½“å‰ç»“æžœä¸ºåŸºå‡†
	if [ ! -f "reports/baseline.json" ]; then
		echo "ðŸ“Š Creating baseline..."
		just test-compatibility-suite
		cp reports/performance-$(date +%Y%m%d).json reports/baseline.json
	fi

	# è¿è¡Œå½“å‰æµ‹è¯•
	just test-compatibility-suite

	# å¯¹æ¯”ç»“æžœ
	cargo run --bin regression-checker -- \
		--baseline reports/baseline.json \
		--current reports/performance-$(date +%Y%m%d).json \
		--output reports/regression-$(date +%Y%m%d).json

	echo "âœ… Regression test completed"

# è¿è¡ŒåŽ‹åŠ›æµ‹è¯•
stress-test:
	#!/usr/bin/env bash
	echo "ðŸ’ª Starting stress test..."

	cargo run --release --bin stress-tester -- \
		--duration 7200 \
		--max-tps 5000 \
		--ramp-up 300 \
		--output ./reports/stress-test-$(date +%Y%m%d).json

	echo "âœ… Stress test completed"

# éªŒè¯å†…å­˜æ³„æ¼
memory-leak-test:
	#!/usr/bin/env bash
	echo "ðŸ” Testing for memory leaks..."

	# ä½¿ç”¨ valgrind æˆ– sanitizers è¿›è¡Œå†…å­˜æ³„æ¼æ£€æµ‹
	RUSTFLAGS="-Z sanitizer=address" cargo test --target x86_64-unknown-linux-gnu

	# é•¿æ—¶é—´è¿è¡Œæµ‹è¯•
	cargo run --release --bin memory-monitor -- \
		--duration 14400 \
		--interval 60 \
		--output ./reports/memory-$(date +%Y%m%d).json

	echo "âœ… Memory leak test completed"

# å¿«é€ŸéªŒè¯ï¼ˆCI ç”¨ï¼‰
quick-verify-suite:
	#!/usr/bin/env bash
	echo "âš¡ Running quick verification..."

	# å¿«é€Ÿå•å…ƒæµ‹è¯•
	cargo test --workspace --release -- --test-threads=4

	# åŸºç¡€åŠŸèƒ½æµ‹è¯•
	timeout 300 cargo run --release --bin arbitrum-reth -- \
		--datadir ./test-data/quick \
		--config test-configs/quick.toml &

	sleep 10

	# åŸºç¡€ RPC æµ‹è¯•
	curl -X POST -H "Content-Type: application/json" \
		--data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
		http://localhost:8548 || echo "âŒ RPC test failed"

	pkill arbitrum-reth

	echo "âœ… Quick verification completed"
